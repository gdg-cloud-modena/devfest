{{ define "main" }}
<main class="section section--padded">
  <h1 class="h1">{{ .Title }}</h1>
  <div class="content">
    {{ .Content }}
  </div>

  <h2 class="h2">Sessioni</h2>

  {{- $speakerSlug := cond (ne .File.BaseFileName "index") .File.BaseFileName (path.Base (path.Clean .File.Dir)) -}}

  {{- $allSessions := slice -}}
  {{- range site.RegularPages -}}
  {{- if in .File.Dir "/sessions/" -}}
  {{- $allSessions = $allSessions | append . -}}
  {{- end -}}
  {{- end -}}

  {{- $bySpeaker := slice -}}
  {{- range $s := $allSessions -}}
  {{- $starts := or ($s.Param "starts") $s.Date -}}
  {{- if and $starts (in $s.Params.speakers $speakerSlug) -}}
  {{- $bySpeaker = $bySpeaker | append $s -}}
  {{- end -}}
  {{- end -}}

  {{- if gt (len $bySpeaker) 0 -}}
  {{- $groups := dict -}}
  {{- range $s := $bySpeaker -}}
  {{- $dt := time (or ($s.Param "starts") $s.Date) -}}
  {{- $year := $dt.Format "2006" -}}
  {{- $list := cond (isset $groups $year) (index $groups $year) (slice) -}}
  {{- $list = $list | append $s -}}
  {{- $groups = merge $groups (dict $year $list) -}}
  {{- end -}}

  {{- $years := slice -}}
  {{- range $k, $_ := $groups -}}
  {{- $years = $years | append $k -}}
  {{- end -}}
  {{- $years = sort $years "value" "desc" -}}

  {{- range $y := $years -}}
  {{- $sessions := index $groups $y -}}
  {{- $sessions = sort $sessions "Params.starts" "asc" -}}
  <h3 class="h3">{{ $y }}</h3>
  <ul class="sessions">
    {{- range $s := $sessions -}}
    {{- $dt := time (or ($s.Param "starts") $s.Date) -}}
    <li class="sessions-item">
      <p class="sessions-itemHead">
        <a class="link" href="{{ $s.RelPermalink }}">{{ $s.Title }}</a>
      </p>
      <p class="sessions-itemDetails">
        Data: {{ $dt.Format "02/01/2006" }} Â· Ora: {{ $dt.Format "15:04" }}
      </p>
    </li>
    {{- end -}}
  </ul>
  {{- end -}}
  {{- else -}}
  <p class="p">Nessuna sessione trovata per {{ .Title }}.</p>
  {{- end -}}
</main>
{{ end }}
