{{ define "main" }}
<main class="section section--padded">
  {{ partial "previous-edition" . }}
  <h1 class="h1">Sala {{ .Title }}</h1>
  <div class="content">
    {{ .Content }}
  </div>

  {{/* Year from cascade param in _index.md */}}
  {{ $year := printf "%v" (.Param "year") }}
  {{ $agenda := index site.Data $year }}

  {{/* Load agenda data for that year */}}
  {{ $days := cond $agenda $agenda.days (slice) }}
  {{ $roomsData := cond $agenda $agenda.rooms (slice) }}

  {{ $roomSlug := cond (ne .File.BaseFileName "index") .File.BaseFileName (path.Base (path.Clean .File.Dir)) }}

  {{/* Sort sessions by date and time */}}
  {{ $sessionsSec := site.GetPage (printf "/%s/sessions" $year) }}
  {{ $sessions := slice }}
  {{ if $sessionsSec }}
    {{ $sessions = where $sessionsSec.Pages "Params.starts" "ne" nil }}
    {{ $sessions = sort $sessions "Params.starts" "asc" }}
  {{ end }}

  <h2 class="h2">Sessioni</h2>

  {{/* Loop over days */}}
  {{ range $day := $days }}
    {{ $dayTime := time.AsTime $day }}
    {{ $dayKey := $dayTime.Format "2006-01-02" }}

    {{/* Collect sessions for that day */}}
    {{ $daySessions := slice }}
    {{ range $session := $sessions }}
      {{ $dt := time ($session.Param "starts") }}
      {{ if and (eq ($dt.Format "2006-01-02") $dayKey) (in $session.Params.rooms $roomSlug) }}
        {{ $daySessions = $daySessions | append $session }}
      {{ end }}
    {{ end }}

    {{ if gt (len $daySessions) 0 }}
      {{ $daySessions = sort $daySessions "Params.starts" "asc" }}

      {{/* Title of the day */}}
      {{ $weekday := $dayTime.Format "Monday" }}
      <h3 class="h3">{{ (time.Format "Monday" $dayTime) | title }}</h3>
    {{ end }}

    {{/* Loop over sessions for that day */}}
    <ul class="sessions">
      {{ range $session := $daySessions }}
        {{ $dt := time ($session.Param "starts") }}

        {{/* Prepare the speaker list */}}
        {{ $speakers := slice }}
        {{ $isMale := true }}
        {{ range $slug := $session.Params.speakers }}
          {{ with site.GetPage (printf "/speakers/%s" $slug) }}
            {{ $isMale = .Params.male }}
            {{ $speakers = $speakers | append (printf `<a class="link" href="%s">%s</a>` .RelPermalink .Title) }}
          {{ else }}
            {{ $speakers = $speakers | append $slug }}
          {{ end }}
        {{ end }}
        {{ $speakersHTML := delimit $speakers ", " }}

        <li class="sessions-item">
          <p class="sessions-itemHead">{{ $dt.Format "15:04" }}-{{ $session.Params.ends | time.Format "15:04" }} Â· <a class="link" href="{{ $session.RelPermalink }}">{{ $session.Title }}</a></p>
          <p class="sessions-itemDetails">
            {{ if eq (len $speakers) 1 }}{{ if $isMale }}Relatore{{ else }}Relatrice{{ end }}: {{ $speakersHTML | safeHTML }}{{ else if gt (len $speakers) 1 }}Relatori: {{ $speakersHTML | safeHTML }}{{ end }} Lingua: <b>{{ $session.Params.language }}</b>
          </p>
        </li>
      {{ end }}
    </ul>
  {{ end }}
</main>
{{ end }}
