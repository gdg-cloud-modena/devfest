{{ define "main" }}

{{/* Year from cascade param in _index.md */}}
{{- $year := printf "%v" (.Param "year") -}}

{{- $agenda := index site.Data $year -}}

{{/* Load agenda data for that year */}}
{{- $days := cond $agenda $agenda.days (slice) -}}
{{- $roomsData := cond $agenda $agenda.rooms (slice) -}}
{{- $roomSlug := cond (ne .File.BaseFileName "index") .File.BaseFileName (path.Base (path.Clean .File.Dir)) -}}

{{/* Sort sessions by date and time */}}
{{- $sessionsSec := site.GetPage (printf "/%s/sessions" $year) -}}
{{- $sessions := slice -}}
{{- if $sessionsSec -}}
  {{- $sessions = where $sessionsSec.Pages "Params.starts" "ne" nil -}}
  {{- $sessions = sort $sessions "Params.ends" "asc" -}}
  {{- $sessions = sort $sessions "Params.starts" "asc" -}}
{{ end }}

{{- $rooms := (site.GetPage (printf "/%s/rooms" $year)).Pages -}}
{{- $pageTitle := .Page.Title -}}


<main class="section section--padded roomPage">
  {{ partial "previous-edition" . }}

  {{ $rooms = where $rooms ".Params.forSessions" true }}
  {{ $numRooms := len $rooms }}
  {{ $currentRoom := . }}
  <p class="p">Sale con sessioni: {{ range $i, $room := $rooms }}{{ if ne $room.File.BaseFileName $currentRoom.File.BaseFileName }}<a class="link" href="{{ $room.RelPermalink }}">{{ $room.Title }}</a>{{ else }}{{ $room.Title }}{{ end }}{{ if ne (add $i 1) $numRooms }}, {{ end }}{{ end }}.</p>

  <h1 class="h1">{{ if .Params.forSessions }}Sala {{ end }}{{ .Title }}</h1>

  <div class="roomPage-description">
    <div class="content">
      {{ .Content }}
    </div>
    {{ $roomImage := resources.Get (printf "%s/rooms/%s.jpg" $year $roomSlug) }}
    {{ if $roomImage }}
    {{ $img := $roomImage.Resize "x300 webp q85" }}
    <img class="roomPage-image" width="{{ $img.Width }}" height="{{ $img.Height }}" src="{{ $img.Permalink }}" alt="{{ .Title }} image">
    {{ end }}
  </div>

  <h2 class="h2">Sessioni</h2>

  {{/* Loop over days */}}
  {{ range $day := $days }}
    {{ $dayTime := time.AsTime $day }}
    {{ $dayKey := $dayTime.Format "2006-01-02" }}

    {{/* Collect sessions for that day */}}
    {{ $daySessions := slice }}
    {{ range $session := $sessions }}
      {{ $dt := time ($session.Param "starts") }}
      {{ if and (eq ($dt.Format "2006-01-02") $dayKey) (in $session.Params.rooms $roomSlug) }}
        {{ $daySessions = $daySessions | append $session }}
      {{ end }}
    {{ end }}

    {{ if gt (len $daySessions) 0 }}
      {{ $daySessions = sort $daySessions "Params.starts" "asc" }}

      {{/* Title of the day */}}
      {{ $weekday := $dayTime.Format "Monday" }}
      <h3 class="h3">{{ (time.Format "Monday" $dayTime) | title }}</h3>
    {{ end }}

    {{/* Loop over sessions for that day */}}
    <ul class="sessions">
      {{ range $session := $daySessions }}
        {{ $dt := time ($session.Param "starts") }}

        {{/* Prepare the speaker list */}}
        {{ $speakers := slice }}
        {{ $isMale := true }}
        {{ range $slug := $session.Params.speakers }}
          {{ with site.GetPage (printf "/speakers/%s" $slug) }}
            {{ $isMale = .Params.male }}
            {{ $speakers = $speakers | append (printf `<a class="link" href="%s">%s</a>` .RelPermalink .Title) }}
          {{ else }}
            {{ $speakers = $speakers | append $slug }}
          {{ end }}
        {{ end }}
        {{ $speakersHTML := delimit $speakers ", " }}

        <li class="sessions-item" data-starts="{{ $session.Params.starts }}" data-ends="{{ $session.Params.ends }}">
          <p class="sessions-itemHead">{{ $dt.Format "15:04" }}-{{ $session.Params.ends | time.Format "15:04" }} · <a class="link" href="{{ $session.RelPermalink }}">{{ $session.Title }}</a></p>
          <p class="sessions-itemDetails">
            {{ if eq (len $speakers) 1 }}{{ if $isMale }}Relatore{{ else }}Relatrice{{ end }}: {{ $speakersHTML | safeHTML }}{{ else if gt (len $speakers) 1 }}Relatori: {{ $speakersHTML | safeHTML }}{{ end }} {{ if ne (lower $session.Params.language) "italiano" }}· {{ $session.Params.language }}{{ end }}
          </p>
        </li>
      {{ end }}
    </ul>
  {{ end }}
</main>
{{ end }}
