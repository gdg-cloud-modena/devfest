{{/*
  Renders the partners grid for the current edition.
  Conventions:
  - Data is in site.Data[year] with .levels and .sponsors
  - Logos path (when available): assets/{year}/partners/{code}.{png|jpg|webp}
  - When logo not found, render a placeholder.
*/}}

{{ $year := site.Params.currentEdition | default (now.Format "2006") }}
{{ $yearStr := printf "%v" $year }}
{{ $dataset := index site.Data $yearStr }}
{{ if not $dataset }}
  {{/* No data for year - nothing to render */}}
  {{ return }}
{{ end }}

{{/* Access via index to avoid type issues, then sort */}}
{{ $levelsRaw := index $dataset "levels" }}
{{ $partners := index $dataset "sponsors" }}
{{ if not $levelsRaw }}{{ return }}{{ end }}
{{ if not $partners }}{{ return }}{{ end }}
{{ $levels := sort $levelsRaw "weight" "asc" }}


<section class="partner-section section section--padded">
  <h2 class="h2 partner-title-section">Partner</h2>

	<div class="partner-levels-container">
		
		{{ range $levels }}
    {{ $level := . }}
    {{ $code := $level.code }}
    {{ $title := $level.title }}
    {{ $items := where $partners "level" $code }}

    {{ if gt (len $items) 0 }}
      <div class="partner-level">
        <div class="partner-level-title">{{ $title }}</div>

        <div class="partner-grid">
          {{ range $items }}
            {{ $name := .name }}
            {{ $code := .code }}
            {{ $link := .link }}

            {{/* Build outbound link with UTM containing the current year */}}
            {{ $utm := site.Params.utm | default "" }}
            {{ $utm = replaceRE `\b20\d{2}\b` $yearStr $utm }}
            {{ if $utm }}
              {{ $sep := "?" }}
              {{ if in $link "?" }}{{ $sep = "&" }}{{ end }}
              {{ $link = printf "%s%s%s" $link $sep $utm }}
            {{ end }}

            {{/* Try to load logo (png, jpg, webp) */}}
            {{ $img := resources.Get (printf "%s/%s/%s" $yearStr "partners" (printf "%s.png" $code)) }}
            {{ if not $img }}{{ $img = resources.Get (printf "%s/%s/%s" $yearStr "partners" (printf "%s.jpg" $code)) }}{{ end }}
            {{ if not $img }}{{ $img = resources.Get (printf "%s/%s/%s" $yearStr "partners" (printf "%s.webp" $code)) }}{{ end }}

            <a
	            class="partner-grid-item"
	            href="{{ $link }}"
	            target="_blank"
	            rel="noopener noreferrer"
	            aria-label="{{ $name }}"
            >
              {{ if $img }}
                {{ $res := $img.Fit "320x160 webp q80" }}
                <img
	                class="partner-logo"
	                src="{{ $res.RelPermalink }}"
	                width="{{ $res.Width }}"
	                height="{{ $res.Height }}"
	                alt="{{ $name }}"
	                loading="lazy"
                />
              {{ else }}
                <span
	                class="partner-logo partner-logo--placeholder"
	                role="img"
	                aria-label="{{ $name }} logo placeholder"
                >
                  <span class="partner-logoText">{{ $name }}</span>
                </span>
              {{ end }}
	            
	            <span class="partner-name">{{ $name }}</span>
	            <span class="partner-logoText-visually-hidden">(opens in a new tab)</span>
	            
	            
            </a>
          {{ end }}
        </div>
      </div>
    {{ end }}
  {{ end }}
	</div>
</section>

