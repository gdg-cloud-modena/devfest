{{/*
  Renders the partners grid for the current edition.
  Conventions:
  - Data is in site.Data[year] with .levels and .partners
  - Sponsors now are in content/partners
  - Logos path (when available): assets/${year}/partners/{code}.{png|jpg|webp}
  - When logo not found, render a placeholder.
*/}}

{{ $year := site.Params.currentEdition | default (now.Format "2006") }}
{{ $yearStr := printf "%v" $year }}
{{ $dataset := index site.Data $yearStr }}
{{ if not $dataset }}
  {{/* No data for year - nothing to render */}}
  {{ return }}
{{ end }}

{{/* Access via index to avoid type issues, then sort */}}
{{ $levelsRaw := index $dataset "levels" }}
{{ $partners := index $dataset "partners" }}
{{ if not $levelsRaw }}{{ return }}{{ end }}
{{ if not $partners }}{{ return }}{{ end }}
{{ $levels := sort $levelsRaw "weight" "asc" }}

<section class="partner-section section section--padded">
  <h2 class="h2 partner-title-section">Partner</h2>

		{{ range $level := $levels }}
    {{ $code := $level.code }}
    {{ $items := where $partners "level" $code }}

    {{ if gt (len $items) 0 }}
      <div class="partners">
        <p class="partners-level">{{ $level.title }}</p>

        <div class="partners-grid">
          {{ range $items }}
            {{ $name := .name }}
            {{ $code := .code }}
            {{ $external := .link }}

            {{ $page := site.GetPage (printf "%s/partners/%s" $yearStr $code) }}
            {{ $hasContent := and $page (gt $page.WordCount 0) }}
            {{ $url := cond $hasContent $page.RelPermalink $external }}

            {{/* Try to load logo (png, jpg, webp) */}}
            {{ $img := resources.Get (printf "%s/%s/%s" $yearStr "partners" (printf "%s.png" $code)) }}
            {{ if not $img }}{{ $img = resources.Get (printf "%s/%s/%s" $yearStr "partners" (printf "%s.jpg" $code)) }}{{ end }}
            {{ if not $img }}{{ $img = resources.Get (printf "%s/%s/%s" $yearStr "partners" (printf "%s.webp" $code)) }}{{ end }}

            <a class="card-body" href="{{ $url }}" aria-label="{{ $name }}">
              {{ if $img }}
                {{ $res := $img.Fit "320x160 webp q80" }}
                <img class="card-logo" src="{{ $res.RelPermalink }}" width="{{ $res.Width }}" height="{{ $res.Height }}" alt="{{ $name }}" loading="lazy">
              {{ else }}
                <span class="card-logo card-logo--placeholder" role="img" aria-label="{{ $name }} logo placeholder">
                  <span class="card-name">{{ $name }}</span>
                </span>
              {{ end }}
	            <span class="card-name">{{ $name }}</span>
            </a>
          {{ end }}
        </div>
      </div>
    {{ end }}
  {{ end }}
</section>
